<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" type="text/css" href="./ext-3.3.0/resources/css/ext-all.css" />
<script type="text/javascript" src="./ext-3.3.0/adapter/ext/ext-base.js"></script>
<script type="text/javascript" src="./ext-3.3.0/ext-all.js"></script>

<script>
Ext.onReady(function(){

    

    function generateArray(row, column) {
        let resultArray = []
        let count = 1
        for (let i = 0; i < row; i++) {
            resultArray[i] = []
            for (let j = 0; j < column; j++) {
                resultArray[i][j] = count
                count++
            }
        }
        return resultArray
    }

    var tpl = new Ext.XTemplate(
        '<table border="1" cellspacing="0">',
            '<tpl for="values">',
                '<tr>',
                '<tpl for="values">',
                    '<td width="20" align="center"> {.} </td>',
                '</tpl>',
                '</tr>',
            '</tpl>',
        '</table>'
    );

    var tableConfig = new Ext.Window({
        width: 200,
        height: 150,
        items: new Ext.form.FormPanel({
            frame: true,
            layout: 'column',
            items: [{
                xtype: 'fieldset',
                title: '',
                items: [{
                    id: 'columnId',
                    xtype: 'textfield',
                    height: 20,
                    width: 150,
                    fieldLabel: 'columns',
                }, {
                    id: 'rowId',
                    xtype: 'textfield',
                    height: 20,
                    width: 150,
                    fieldLabel: 'rows',
                }],
            }],
            buttons: [{
                text: 'add',
                handler: function (b, f) {
                    let row = Ext.getCmp('rowId').getValue()
                    let column = Ext.getCmp('columnId').getValue()
                    let data = generateArray(row, column)
                    let editorText = Ext.getCmp('text-area').getValue() + tpl.apply(data);
                    Ext.getCmp('text-area').setValue(editorText);
                    tableConfig.close()
                }
            }]
        })
    });

    function resetTextArea() {
        Ext.getCmp('reply-form').getForm().reset();
    }

    function insertTable() {
        tableConfig.show();
    }

    let editMenu = new Ext.menu.Menu({
        items: [
            {
                text: 'reset',
                handler: resetTextArea
            }
        ]
    });

    let insertMenu = new Ext.menu.Menu({
        items: [
            {
                text: 'table',
                handler: insertTable
            }
        ]
    });

    let toolbar = new Ext.Toolbar({
        width: 700,
        items: [
            {
                text: 'Edit',
                menu: editMenu
            },
            {
                text: 'Insert',
                menu: insertMenu
            }

        ]
    });

    let editor = new Ext.form.HtmlEditor({
        id: 'text-area',
        width: 700,
        height: 500
    });

    let replyForm = new Ext.form.FormPanel({
        id: 'reply-form',
        width: 700,
        height: 500,
        hideLabels: true,
        items: [
            editor
        ],
        buttons: [
            {
                text: 'reply',
                listeners: {
                    click: function() {
                        if(!Ext.getCmp('text-area').getValue().trim()){
                            return;
                        }
                        var progressBar = new Ext.ProgressBar({
                            renderTo: 'progress-bar',
                            style: {
                                 marginLeft: '40%',
                                 marginTop: 20
                            },
                            width: 300
                        });
                        progressBar.wait({
                            duration: 3000,
                            interval: 1000,
                            increment: 3,
                            text: 'waiting',
                            scope: this,
                            fn: function () {
                                Ext.Msg.alert('tips', 'success!')
                                progressBar.hide();
                            }
                        });
                    }
                }
            }

        ]
    });

    let contextMenu = new Ext.menu.Menu({
        items: [
            {
                text: 'Edit',
                menu: {
                    items: [
                        {
                            text: 'reset',
                            handler: resetTextArea
                        }
                    ]
                }
            },
            {
                text: 'Insert',
                menu: {
                    items: [
                        {
                            text: 'table',
                            handler: insertTable
                        }
                    ]
                }
            }
        ]
    })

    Ext.get(document).on('contextmenu', function(event) {
        event.preventDefault();
        contextMenu.showAt(event.getXY());
    });

    let view = new Ext.Viewport({
        items: [
            toolbar,
            replyForm
        ]
    });
});
</script>
</head>
<body>
    <div id='table'></div>
    <div id='progress-bar' style="text-align: center"></div>
</body>

</html>
